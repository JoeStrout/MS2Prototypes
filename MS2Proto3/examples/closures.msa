# MiniScript code:
#	makeCounter = function(name)
#       count = 0
#		f = function
#           outer.count += 1
#			print name + " " + count
#		end function
#		return @f
#	end function
#
#	f1 = makeCounter("foo")
#	f2 = makeCounter("bar")
#	f1  // prints "foo 1"
#	f2  // prints "bar 1"
#	f1  // prints "foo 2"

@fDef:
    OUTER r1
	LOAD r2, "count"
	INDEX r3, r1, r2      # r3 = outer.count
	LOAD r4, 1
	ADD r3, r3, r4        # r3 += 1
	IDXSET r1, r2, r3     # outer.name = r3
	LOADV r0, r0, "name"  # won't match here, so will search outer
	LOAD r4, " "
	ADD r0, r0, r4        # append a space to value we found
	ADD r0, r0, r3        # and then the count from above
	CALLFN 0, "print"     # print result
	RETURN

@makeCounter:
	.param name           # r1
	LOAD r2, 0
	NAME r2, "count"
	FUNCREF r0, @fDef
	RETURN

@main:
	FUNCREF r1, @makeCounter
	NAME r1, "makeCounter"    # makeCounter = function(...)
	
	LOAD r4, "foo"
	ARGBLK 1
	ARG r4
	CALL r2, r4, r1
	NAME r2, "f1"             # f1 = makeCounter("foo")
	
	LOAD r4, "bar"
	ARGBLK 1
	ARG r4
	CALL r3, r4, r1
	NAME r3, "f2"            # f2 = makeCounter("bar")
		
	LOADC r0, r2, "f1"        # f1
	LOADC r0, r3, "f2"        # f2
	LOADC r0, r2, "f1"        # f1

	LOAD r0, "Closure test complete."
	CALLFN 0, "print"
	RETURN

